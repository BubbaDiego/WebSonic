{% extends "sonic_admin.html" %}
{% block content %}

<style>
  /* Same color scheme for top boxes and card backgrounds */
  .price-box.card {
    background-color: #F0F0F0 !important;
    border: 2px solid #ccc;
    border-radius: 8px;
  }
  .price-box .card-header {
    background-color: #e5ffe5 !important;
    font-weight: bold;
  }
  .price-box .display-4 {
    font-size: 2.5rem; /* Big price font */
  }

  /* Recent Prices table: striped full-width */
  .recent-prices-table.table-striped tbody tr:nth-of-type(odd) {
    background-color: rgba(0, 0, 0, 0.05);
  }
  .recent-prices-table thead tr.title-row,
  .recent-prices-table thead tr.column-header-row {
    background-color: #e5ffe5 !important;
  }
  .recent-prices-table thead tr.title-row th,
  .recent-prices-table thead tr.column-header-row th {
    font-weight: bold;
  }

  /* Add Price Card styling */
  .card.add-price {
    background-color: #F0F0F0 !important;
  }
  .card.add-price .card-header {
    background-color: #e5ffe5 !important;
    font-weight: bold;
  }
</style>

<!-- ====== SECTION 1: Title + Update Button + Boxes ====== -->
<div class="d-flex justify-content-between align-items-center mb-3">
  <h2 class="text-dark mb-0">Prices</h2>
  <!-- POST to /update_prices (we’ll intercept it with JS so we do not remove anything) -->
  <form method="POST" action="{{ url_for('update_prices') }}" id="updatePricesForm">
    <button type="submit" class="btn btn-success">Update Prices</button>
  </form>
</div>

<!-- Row of up to 3 “info boxes” from your “prices” list -->
<div class="row row-cols-1 row-cols-md-3 g-4 mb-4">
  {% for p in prices[:3] %}
  <div class="col">
    <div class="card price-box h-100">
      <div class="card-header d-flex align-items-center justify-content-center">
        {% if p.asset_type in ["BTC", "Bitcoin"] %}
          <img src="/static/images/btc_logo.png" alt="BTC" 
               style="width: 30px; height: 30px; margin-right: 10px;">
        {% elif p.asset_type in ["ETH", "Ethereum"] %}
          <img src="/static/images/eth_logo.png" alt="ETH" 
               style="width: 30px; height: 30px; margin-right: 10px;">
        {% elif p.asset_type in ["SOL", "Solana"] %}
          <img src="/static/images/sol_logo.png" alt="SOL" 
               style="width: 30px; height: 30px; margin-right: 10px;">
        {% endif %}

        <!-- Keep your original span, but hide it -->
        <span style="display: none;">{{ p.asset_type }}</span>

        <!-- Show a nicer label instead -->
        {% if p.asset_type == "BTC" or p.asset_type == "AssetType.BTC" %}
          <span>Bitcoin</span>
        {% elif p.asset_type == "ETH" or p.asset_type == "AssetType.ETH" %}
          <span>Ethereum</span>
        {% elif p.asset_type == "SOL" or p.asset_type == "AssetType.SOL" %}
          <span>Solana</span>
        {% else %}
          <span>{{ p.asset_type }}</span>
        {% endif %}
      </div>
      <div class="card-body text-center">
        <div class="display-4 mb-2">
          {{ p.current_price }}
        </div>
        <small class="text-muted">
          Last Updated: {{ p.last_update_time_pst or "N/A" }}
        </small>
      </div>
    </div>
  </div>
  {% endfor %}
</div>

<!-- ====== SECTION 2: “Recent Prices” Table (historical log) ====== -->

{% if recent_prices is not defined %}
  {% set recent_prices = [] %}
{% endif %}

<div class="card mb-4" style="background-color: #F0F0F0;">
  <div class="card-body p-2">
    <table class="table table-striped recent-prices-table w-100 mb-0">
      <thead>
        <!-- Title row with “Recent Prices” & pagination -->
        <tr class="title-row">
          <th colspan="2">Recent Prices</th>
          <th class="text-end">
            <!-- Pagination UI placeholder if you want real pagination later -->
            <nav>
              <ul class="pagination justify-content-end m-0">
                <li class="page-item disabled">
                  <a class="page-link" href="#" tabindex="-1">«</a>
                </li>
                <li class="page-item active"><a class="page-link" href="#">1</a></li>
                <li class="page-item"><a class="page-link" href="#">2</a></li>
                <li class="page-item"><a class="page-link" href="#">3</a></li>
                <li class="page-item"><a class="page-link" href="#">»</a></li>
              </ul>
            </nav>
          </th>
        </tr>
        <!-- Column headers row -->
        <tr class="column-header-row">
          <th>Asset</th>
          <th>Update Time</th>
          <th>Price</th>
        </tr>
      </thead>
      <tbody>
        {% for rp in recent_prices[::-1][:10] %}
        <tr>
          <!-- Keep your existing display. Just add the if/else for nicer labels. -->
          <td>
            {% if rp.asset_type in ["BTC", "Bitcoin"] %}
              <img src="/static/images/btc_logo.png" alt="BTC"
                   style="width:20px; height:20px; margin-right:5px;">
            {% elif rp.asset_type in ["ETH", "Ethereum"] %}
              <img src="/static/images/eth_logo.png" alt="ETH"
                   style="width:20px; height:20px; margin-right:5px;">
            {% elif rp.asset_type in ["SOL", "Solana"] %}
              <img src="/static/images/sol_logo.png" alt="SOL"
                   style="width:20px; height:20px; margin-right:5px;">
            {% endif %}

            <!-- Original line, hidden: -->
            <span style="display: none;">{{ rp.asset_type }}</span>

            <!-- Friendly label: -->
            {% if rp.asset_type == "BTC" or rp.asset_type == "AssetType.BTC" %}
              <span>Bitcoin</span>
            {% elif rp.asset_type == "ETH" or rp.asset_type == "AssetType.ETH" %}
              <span>Ethereum</span>
            {% elif rp.asset_type == "SOL" or rp.asset_type == "AssetType.SOL" %}
              <span>Solana</span>
            {% else %}
              <span>{{ rp.asset_type }}</span>
            {% endif %}
          </td>
          <td>{{ rp.last_update_time_pst or "N/A" }}</td>
          <td>{{ rp.current_price }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<!-- ====== SECTION 3: Add New Price Panel ====== -->
<div class="card add-price">
  <div class="card-header">Add New Price</div>
  <div class="card-body">
    <form method="POST" action="{{ url_for('prices') }}">
      <div class="row g-3">
        <!-- Asset -->
        <div class="col-md-4">
          <label for="asset" class="form-label fw-bold">Asset</label>
          <select class="form-select" id="asset" name="asset" required>
            <option value="BTC">BTC</option>
            <option value="ETH">ETH</option>
            <option value="SOL">SOL</option>
          </select>
        </div>
        <!-- Price -->
        <div class="col-md-4">
          <label for="price" class="form-label fw-bold">Price</label>
          <input
            type="number"
            step="0.01"
            class="form-control"
            id="price"
            name="price"
            required
          />
        </div>
        <div class="col-md-4 d-flex align-items-end">
          <button type="submit" class="btn btn-primary w-100">Add Price</button>
        </div>
      </div>
    </form>
  </div>
</div>

<!-- ====== SECTION 4: JavaScript to Intercept “Update Prices” & Reload ====== -->
<script>
  window.addEventListener('DOMContentLoaded', () => {
    const updatePricesForm = document.getElementById('updatePricesForm');
    if (updatePricesForm) {
      updatePricesForm.addEventListener('submit', (event) => {
        event.preventDefault(); // Stop normal POST
        fetch('{{ url_for("update_prices") }}', {
          method: 'POST'
        })
        .then(res => res.json())
        .then(data => {
          console.log('Update Prices response:', data);
          // After the JSON success message, reload the page to see new data:
          window.location.reload();
        })
        .catch(err => console.error('Error updating prices:', err));
      });
    }
  });
</script>

{% endblock content %}
