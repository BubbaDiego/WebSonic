{% extends "sonic_admin.html" %}
{% block content %}
<h2 class="text-dark mb-4">Positions</h2>

<!-- Positions Table -->
<table class="table table-striped table-bordered mb-5">
  <thead>
    <tr>
      <th>üìä Asset</th>
      <th>üîñ Type</th>
      <th>üí∞ Collateral</th>
      <th>üìà Value</th>
      <th>üìè Size</th>
      <th>‚öôÔ∏è Leverage</th>
      <th>üìâ Travel %</th>
      <th>üî• Heat Index</th>  <!-- Renamed in header -->
      <th>üíß Liquidation Price</th>
      <th>Actions</th>
    </tr>
  </thead>
  <tbody>
    {% for pos in positions %}
    <tr>
      <!-- Asset + Logo -->
      <td>
        {% if pos.asset_type in ["BTC", "Bitcoin"] %}
          <img
            src="/static/images/btc_logo.png"
            alt="BTC"
            style="width: 20px; height: 20px; margin-right: 5px;"
          />
        {% elif pos.asset_type in ["ETH", "Ethereum"] %}
          <img
            src="/static/images/eth_logo.png"
            alt="ETH"
            style="width: 20px; height: 20px; margin-right: 5px;"
          />
        {% elif pos.asset_type in ["SOL", "Solana"] %}
          <img
            src="/static/images/sol_logo.png"
            alt="SOL"
            style="width: 20px; height: 20px; margin-right: 5px;"
          />
        {% endif %}
        {{ pos.asset_type }}
      </td>

      <!-- Position Type -->
      <td><b>{{ pos.position_type }}</b></td>

      <!-- Collateral (inline edit) -->
      <td>
        <span id="span-collateral-{{ pos.id }}">
          {{ "{:,}".format(pos.collateral) }}
        </span>
        <input
          type="number"
          step="0.01"
          class="form-control d-none"
          id="edit-collateral-{{ pos.id }}"
          value="{{ pos.collateral }}"
        />
      </td>

      <!-- Value -->
      <td>{{ "{:,}".format(pos.value) }}</td>

      <!-- Size (inline edit) -->
      <td>
        <span id="span-size-{{ pos.id }}">
          {{ "{:,}".format(pos.size) }}
        </span>
        <input
          type="number"
          step="0.01"
          class="form-control d-none"
          id="edit-size-{{ pos.id }}"
          value="{{ pos.size }}"
        />
      </td>

      <!-- Leverage -->
      <td>{{ pos.leverage|float|round(2) }}</td>

      <!-- Travel % -->
      <td>
        {% if pos.current_travel_percent is not none %}
          {{ pos.current_travel_percent|round(2) }}%
        {% else %}
          N/A
        {% endif %}
      </td>

      <!-- Heat Index -->
      <td>
        {% if pos.heat_index is not none %}
          {{ "{:,}".format(pos.heat_index) }}
        {% else %}
          N/A
        {% endif %}
      </td>

      <!-- Liquidation Price -->
      <td>
        {% if pos.liquidation_price is not none %}
          {{ pos.liquidation_price|float|round(2) }}
        {% else %}
          N/A
        {% endif %}
      </td>

      <!-- Actions (Edit, Delete) -->
      <td>
        <!-- Edit Button -->
        <button
          type="button"
          class="btn btn-sm btn-primary"
          onclick="enableEdit('{{ pos.id }}')"
          id="edit-btn-{{ pos.id }}"
        >
          Edit
        </button>

        <!-- Hidden form to submit updated Collateral/Size -->
        <form
          method="POST"
          action="{{ url_for('edit_position', position_id=pos.id) }}"
          id="edit-form-{{ pos.id }}"
          class="d-none"
        >
          <input
            type="hidden"
            name="collateral"
            id="hidden-collateral-{{ pos.id }}"
            value="{{ pos.collateral }}"
          />
          <input
            type="hidden"
            name="size"
            id="hidden-size-{{ pos.id }}"
            value="{{ pos.size }}"
          />
          <button type="submit" class="btn btn-sm btn-success">Save</button>
          <button
            type="button"
            class="btn btn-sm btn-secondary"
            onclick="cancelEdit('{{ pos.id }}')"
          >
            Cancel
          </button>
        </form>

        <!-- Delete Button -->
        <form
          method="POST"
          action="/delete-position/{{ pos.id }}"
          style="display: inline;"
        >
          <button type="submit" class="btn btn-sm btn-danger">
            Delete
          </button>
        </form>
      </td>
    </tr>
    {% endfor %}
  </tbody>

  <!-- Totals Row -->
  <tfoot>
    <tr class="fw-bold">
      <td>Totals</td>
      <td></td>
      <td>{{ "{:,}".format(totals.get("total_collateral", 0)) }}</td>
      <td>{{ "{:,}".format(totals.get("total_value", 0)) }}</td>
      <td>{{ "{:,}".format(totals.get("total_size", 0)) }}</td>
      <td>{{ "{:,}".format(totals.get("avg_leverage", 0)) }}</td>
      <td>{{ "{:,}".format(totals.get("avg_travel_percent", 0)) }}%</td>

      <!-- Now referencing "avg_heat_index" instead of "avg_heat_points" -->
      <td>{{ "{:,}".format(totals.get("avg_heat_index", 0)) }}</td>

      <td></td>
      <td></td>
    </tr>
  </tfoot>
</table>

<!-- Card with "Add New Position" on the left and "Upload JSON" on the right -->
<div class="card">
  <div class="card-header fw-bold">Add New Position / Import JSON</div>
  <div class="card-body">
    <div class="row g-3">
      <!-- Left Column: Add New Position Form -->
      <div class="col-md-6">
        <form method="POST" action="{{ url_for('positions') }}">
          <div class="row g-3">
            <!-- Asset -->
            <div class="col-md-6">
              <label for="asset_type" class="form-label fw-bold">
                Asset <span class="ms-1">üí∞</span>
              </label>
              <select class="form-select" id="asset_type" name="asset_type" required>
                <option value="BTC">BTC</option>
                <option value="ETH">ETH</option>
                <option value="SOL">SOL</option>
              </select>
            </div>

            <!-- Position Type -->
            <div class="col-md-6">
              <label for="position_type" class="form-label fw-bold">
                Position Type <span class="ms-1">üîß</span>
              </label>
              <select class="form-select" id="position_type" name="position_type" required>
                <option value="Long">Long</option>
                <option value="Short">Short</option>
              </select>
            </div>

            <!-- Collateral -->
            <div class="col-md-6">
              <label for="collateral" class="form-label fw-bold">
                Collateral <span class="ms-1">üîí</span>
              </label>
              <input
                type="number"
                step="0.01"
                class="form-control"
                id="collateral"
                name="collateral"
                required
              />
            </div>

            <!-- Size -->
            <div class="col-md-6">
              <label for="size" class="form-label fw-bold">
                Size <span class="ms-1">üìè</span>
              </label>
              <input
                type="number"
                step="0.01"
                class="form-control"
                id="size"
                name="size"
                required
              />
            </div>

            <!-- Entry Price -->
            <div class="col-md-6">
              <label for="entry_price" class="form-label fw-bold">
                Entry Price <span class="ms-1">üí≤</span>
              </label>
              <input
                type="number"
                step="0.01"
                class="form-control"
                id="entry_price"
                name="entry_price"
                required
              />
            </div>

            <!-- Liquidation Price -->
            <div class="col-md-6">
              <label for="liquidation_price" class="form-label fw-bold">
                Liquidation Price <span class="ms-1">‚ö†Ô∏è</span>
              </label>
              <input
                type="number"
                step="0.01"
                class="form-control"
                id="liquidation_price"
                name="liquidation_price"
                required
              />
            </div>

            <div class="col-md-12 text-end">
              <button type="submit" class="btn btn-primary">Add Position</button>
            </div>
          </div>
        </form>
      </div>

      <!-- Right Column: Upload JSON (Drag & Drop) -->
      <div class="col-md-6">
        <label for="file-input" class="form-label fw-bold">
          Import from JSON <span class="ms-1">üìÑ</span>
        </label>
        <div
          id="drop-area"
          class="border border-primary rounded p-3 text-center"
          style="min-height: 120px;"
        >
          <p class="mb-2">Drag &amp; drop a JSON file here or click to select</p>
          <input
            type="file"
            id="file-input"
            style="display: none;"
            accept=".json"
          />
          <button
            type="button"
            class="btn btn-secondary"
            onclick="document.getElementById('file-input').click();"
          >
            Browse
          </button>
        </div>

        <button type="button" id="upload-btn" class="btn btn-success mt-2" disabled>
          Upload Positions
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Inline Edit Script -->
<script>
function enableEdit(posId) {
  // Hide the Edit button
  document.getElementById(`edit-btn-${posId}`).classList.add("d-none");
  // Show the hidden form's Save/Cancel
  document.getElementById(`edit-form-${posId}`).classList.remove("d-none");

  // Show input fields for Collateral and Size
  document.getElementById(`span-collateral-${posId}`).classList.add("d-none");
  document.getElementById(`edit-collateral-${posId}`).classList.remove("d-none");

  document.getElementById(`span-size-${posId}`).classList.add("d-none");
  document.getElementById(`edit-size-${posId}`).classList.remove("d-none");
}

function cancelEdit(posId) {
  // Show the Edit button
  document.getElementById(`edit-btn-${posId}`).classList.remove("d-none");
  // Hide the Save/Cancel
  document.getElementById(`edit-form-${posId}`).classList.add("d-none");

  // Hide input fields, restore text
  document.getElementById(`span-collateral-${posId}`).classList.remove("d-none");
  document.getElementById(`edit-collateral-${posId}`).classList.add("d-none");

  document.getElementById(`span-size-${posId}`).classList.remove("d-none");
  document.getElementById(`edit-size-${posId}`).classList.add("d-none");
}

// Hook input changes to hidden form fields
document.querySelectorAll('input[id^="edit-collateral-"]').forEach((inputEl) => {
  inputEl.addEventListener("input", function() {
    const posId = this.id.split("-")[2];
    document.getElementById(`hidden-collateral-${posId}`).value = this.value;
  });
});

document.querySelectorAll('input[id^="edit-size-"]').forEach((inputEl) => {
  inputEl.addEventListener("input", function() {
    const posId = this.id.split("-")[2];
    document.getElementById(`hidden-size-${posId}`).value = this.value;
  });
});

// Drag & Drop + File Upload for JSON
const dropArea = document.getElementById('drop-area');
const fileInput = document.getElementById('file-input');
const uploadBtn = document.getElementById('upload-btn');
let selectedFile = null;

// Highlight drop area on drag events
dropArea.addEventListener('dragover', (e) => {
  e.preventDefault();
  dropArea.classList.add('bg-light');
});
dropArea.addEventListener('dragleave', () => {
  dropArea.classList.remove('bg-light');
});

// Handle file drop
dropArea.addEventListener('drop', (e) => {
  e.preventDefault();
  dropArea.classList.remove('bg-light');
  selectedFile = e.dataTransfer.files[0];

  if (selectedFile && selectedFile.type === 'application/json') {
    uploadBtn.disabled = false;
  } else {
    alert('Please drop a valid JSON file.');
    selectedFile = null;
    uploadBtn.disabled = true;
  }
});

// Click drop area -> open file dialog
dropArea.addEventListener('click', () => fileInput.click());

// If user picks a file from the dialog
fileInput.addEventListener('change', () => {
  selectedFile = fileInput.files[0];
  if (selectedFile && selectedFile.type === 'application/json') {
    uploadBtn.disabled = false;
  } else {
    alert('Please select a valid JSON file.');
    selectedFile = null;
    uploadBtn.disabled = true;
  }
});

// Upload button -> POST to /upload-positions
uploadBtn.addEventListener('click', () => {
  if (!selectedFile) return;
  const formData = new FormData();
  formData.append('file', selectedFile);

  fetch('/upload-positions', {
    method: 'POST',
    body: formData
  })
  .then((response) => {
    if (response.ok) {
      alert('Positions imported successfully!');
      location.reload();
    } else {
      alert('Failed to import positions.');
    }
  })
  .catch((err) => {
    console.error(err);
    alert('An error occurred while uploading.');
  });
});
</script>
{% endblock content %}
